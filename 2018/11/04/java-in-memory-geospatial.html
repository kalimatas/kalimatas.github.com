<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/static/css/style.css" type="text/css" />
	<link rel="stylesheet" href="/static/css/pygments.css" type="text/css" />
	<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Java Geospatial In-memory Index | Alexander Guz’s blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Java Geospatial In-memory Index" />
<meta name="author" content="Alexander Guz" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Copmarison of several in-memory geospatial indices for Java." />
<meta property="og:description" content="Copmarison of several in-memory geospatial indices for Java." />
<link rel="canonical" href="https://guzalexander.com/2018/11/04/java-in-memory-geospatial.html" />
<meta property="og:url" content="https://guzalexander.com/2018/11/04/java-in-memory-geospatial.html" />
<meta property="og:site_name" content="Alexander Guz’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-04T19:12:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Java Geospatial In-memory Index" />
<meta name="twitter:site" content="@kalimatas" />
<meta name="twitter:creator" content="@Alexander Guz" />
<script type="application/ld+json">
{"headline":"Java Geospatial In-memory Index","dateModified":"2018-11-04T19:12:00+01:00","datePublished":"2018-11-04T19:12:00+01:00","url":"https://guzalexander.com/2018/11/04/java-in-memory-geospatial.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://guzalexander.com/2018/11/04/java-in-memory-geospatial.html"},"author":{"@type":"Person","name":"Alexander Guz"},"description":"Copmarison of several in-memory geospatial indices for Java.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>

	<section class="container">
		<nav class="menu">
			<ul>
				<li><a class="nav-link fancy-hover" href="/"><span>Home</span></a></li>
				<li><a class="nav-link fancy-hover" href="/archive/"><span>Archive</span></a></li>
				<li><a class="nav-link fancy-hover" href="/about/"><span>About</span></a></li>
			</ul>
			<ul>
				<li>
					<a class="nav-link fancy-hover" href="https://twitter.com/kalimatas" target="_blank" >
						<span>
							<img alt="Twitter" width="18" height="18" title="Twitter" src="/static/img/twitter_new.svg" />
						</span>
					</a>
				</li>
				<li>
					<a class="nav-link fancy-hover" href="https://github.com/kalimatas" target="_blank">
						<span>
							<img alt="GitHub" width="18" height="18" title="GitHub" src="/static/img/github_new.svg" />
						</span>
					</a>
				</li>
				<li>
					<a class="nav-link fancy-hover" href="https://linkedin.com/in/kalimatas" target="_blank" >
						<span>
							<img alt="LinkedIn" width="18" height="18" title="LinkedIn" src="/static/img/linkedin_new.svg" />
						</span>
					</a>
				</li>
			</ul>
		</nav>

		<section class="main-wrapper">
			<section class="main">
				<article>
	
	<h1><span>Java Geospatial In-memory Index</span></h1>
	<section class="post-meta">
		
		<time>November 4, 2018</time> • <span class="reading-time" title="Estimated read time">
  
  
    13 mins read
  
</span>

	</section>
	
	<section class="description">
		Copmarison of several in-memory geospatial indices for Java.
	</section>
	
	<section id="article-content">
		<p>One of my recent tasks included searching for objects within some radius based on their geo coordinates. 
For various reasons — not relevant to this topic — I wanted to make this work completely in 
memory. 
That’s why solutions like <a href="https://dev.mysql.com/doc/refman/8.0/en/spatial-types.html">MySQL Spatial Data Types</a>, <a href="https://postgis.net/">PostGIS</a> or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html">Elasticsearch Geo Queries</a> were not considered. The project is in Java. I started to look for possible options, and, though, I found a few, they all lacked an easy to follow documentation (if at all) and examples.</p>

<p>So I decided to make a short description of some Java in-memory geospatial indices I’ve discovered during my research with code examples and benchmarks done with <a href="http://openjdk.java.net/projects/code-tools/jmh/">jmh</a>.</p>

<p>Again, the task at hand: given a geo point, find the nearest to it object within a given radius using in-memory data structures. As an extra requirement, we would like to have arbitrary data attached to the objects stored in this data structures. The reason is that, in most cases, these objects are not merely geo points, they are rather some domain entities, and we would build our business logic based on them. In our case, the arbitrary data will be just an integer ID, and we pretend we can later fetch required entity from some repository by this ID.</p>

<div class="img-wrapper">
	<figure>
		
			<img src="/static/img/posts/geo_circle.jpg" alt="Figure 1. We need to find all green points within the radius of D km from the source point S." />
		
	</figure>
</div>

<figcaption>Figure 1. We need to find all green points within the radius of D km from the source point S.</figcaption>

<h2 id="lucene-spatial-extras">Lucene spatial extras</h2>

<p>I learned about Lucene while using Elasticsearch, because it’s based on it <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>. I thought: well, 
Elasticsearch has Geo queries made with Lucene, which means Lucene has support for it, which, maybe, also has support for in-memory geospatial index. And I was right. Lucene project has <a href="https://lucene.apache.org/core/7_4_0/spatial-extras/index.html">Spatial-Extras module</a>, that <em>encapsulates an approach to indexing and searching based on shapes</em>.</p>

<p>Using this module turned out to be a non-trivial task. Except JavaDocs and source code, I could only find an example of its usage in <a href="https://github.com/apache/lucene-solr/blob/master/lucene/spatial-extras/src/test/org/apache/lucene/spatial/SpatialExample.java">Apache Solr + Lucene repository</a>, and made my implementation based on it. Lucene provides generalised approach to indexing and searching different types of data, and geospatial index is just one of the flavours.</p>

<p>Let’s have a look at the example.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="nc">SpatialContext</span> <span class="n">spatialCxt</span> <span class="o">=</span> <span class="nc">SpatialContext</span><span class="o">.</span><span class="na">GEO</span><span class="o">;</span>
<span class="kd">final</span> <span class="nc">ShapeFactory</span> <span class="n">shapeFactory</span> <span class="o">=</span> <span class="n">spatialCxt</span><span class="o">.</span><span class="na">getShapeFactory</span><span class="o">();</span>
<span class="kd">final</span> <span class="nc">SpatialStrategy</span> <span class="n">coordinatesStrategy</span> <span class="o">=</span>
	<span class="k">new</span> <span class="nf">RecursivePrefixTreeStrategy</span><span class="o">(</span><span class="k">new</span> <span class="nc">GeohashPrefixTree</span><span class="o">(</span><span class="n">spatialCxt</span><span class="o">,</span> <span class="mi">5</span><span class="o">),</span> <span class="s">"coordinates"</span><span class="o">);</span>

<span class="c1">// Create an index</span>
<span class="kd">final</span> <span class="nc">Directory</span> <span class="n">directory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RAMDirectory</span><span class="o">();</span>
<span class="nc">IndexWriterConfig</span> <span class="n">iwConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexWriterConfig</span><span class="o">();</span>
<span class="nc">IndexWriter</span> <span class="n">indexWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexWriter</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">iwConfig</span><span class="o">);</span>

<span class="c1">// Index some documents</span>
<span class="kt">var</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
	<span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">50.4</span><span class="no">D</span><span class="o">,</span> <span class="mf">51.4</span><span class="no">D</span><span class="o">);</span>
	<span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">8.2</span><span class="no">D</span><span class="o">,</span> <span class="mf">11.2</span><span class="no">D</span><span class="o">);</span>

	<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Document</span><span class="o">();</span>
	<span class="n">doc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">StoredField</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">()));</span>
	<span class="kt">var</span> <span class="n">point</span> <span class="o">=</span> <span class="n">shapeFactory</span><span class="o">.</span><span class="na">pointXY</span><span class="o">(</span><span class="n">longitude</span><span class="o">,</span> <span class="n">latitude</span><span class="o">);</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">field</span> <span class="o">:</span> <span class="n">coordinatesStrategy</span><span class="o">.</span><span class="na">createIndexableFields</span><span class="o">(</span><span class="n">point</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">doc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="n">doc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">StoredField</span><span class="o">(</span><span class="n">coordinatesStrategy</span><span class="o">.</span><span class="na">getFieldName</span><span class="o">(),</span> <span class="n">latitude</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">));</span>
	<span class="n">indexWriter</span><span class="o">.</span><span class="na">addDocument</span><span class="o">(</span><span class="n">doc</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">indexWriter</span><span class="o">.</span><span class="na">forceMerge</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">indexWriter</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

<span class="c1">// Query the index</span>
<span class="kd">final</span> <span class="nc">IndexReader</span> <span class="n">indexReader</span> <span class="o">=</span> <span class="nc">DirectoryReader</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">directory</span><span class="o">);</span>
<span class="nc">IndexSearcher</span> <span class="n">indexSearcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexSearcher</span><span class="o">(</span><span class="n">indexReader</span><span class="o">);</span>

<span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">50.4</span><span class="no">D</span><span class="o">,</span> <span class="mf">51.4</span><span class="no">D</span><span class="o">);</span>
<span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">8.2</span><span class="no">D</span><span class="o">,</span> <span class="mf">11.2</span><span class="no">D</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">double</span> <span class="no">NEARBY_RADIUS_DEGREE</span> <span class="o">=</span> <span class="nc">DistanceUtils</span><span class="o">.</span><span class="na">dist2Degrees</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="nc">DistanceUtils</span><span class="o">.</span><span class="na">EARTH_MEAN_RADIUS_KM</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">var</span> <span class="n">spatialArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SpatialArgs</span><span class="o">(</span><span class="nc">SpatialOperation</span><span class="o">.</span><span class="na">IsWithin</span><span class="o">,</span>
										<span class="n">shapeFactory</span><span class="o">.</span><span class="na">circle</span><span class="o">(</span><span class="n">longitude</span><span class="o">,</span> <span class="n">latitude</span><span class="o">,</span> <span class="no">NEARBY_RADIUS_DEGREE</span><span class="o">));</span>
<span class="kd">final</span> <span class="nc">Query</span> <span class="n">q</span> <span class="o">=</span> <span class="n">coordinatesStrategy</span><span class="o">.</span><span class="na">makeQuery</span><span class="o">(</span><span class="n">spatialArgs</span><span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="nc">TopDocs</span> <span class="n">topDocs</span> <span class="o">=</span> <span class="n">indexSearcher</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">topDocs</span><span class="o">.</span><span class="na">totalHits</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kt">var</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">indexSearcher</span><span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="n">topDocs</span><span class="o">.</span><span class="na">scoreDocs</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">doc</span><span class="o">);</span>
	<span class="kt">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">numericValue</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>In order to use it we need:</p>
<ol>
  <li><strong>Create an index</strong>. At this step you can choose where to store the index. For our use case, there is a <a href="https://github.com/apache/lucene-solr/blob/master/lucene/core/src/java/org/apache/lucene/store/RAMDirectory.java">RAMDirectory</a>, which is essentially in-memory storage. This class is marked as deprecated, because it <em>uses inefficient synchronization</em> according to the documentation. This might explain its poor performance. But we’ll come back to this later.</li>
  <li><strong>Index some documents</strong>. To make our index support geospatial queries we need to have a field of type Shape, in particular <a href="https://github.com/locationtech/spatial4j/blob/master/src/main/java/org/locationtech/spatial4j/shape/Point.java">Point</a> in our document.</li>
  <li><strong>Query the index</strong>. Perform a spatial operation against the index.</li>
</ol>

<p>Oh my gosh! That’s a good deal of classes to consider! That is definitely not the winner of the contest on “The most clear and easy to use API”. Though, as you would expect, Lucene indices are the most flexible:</p>
<ul>
  <li>Provides various shapes implementations: point, rectangle, and circle. You can also teach it to support polygons with some additional dependency.</li>
  <li>You can put any data to the indexed document along with its geo point. It means you can store the whole entity there and perform other queries supported by Lucene, for example, fuzzy text matching.</li>
  <li>Supports various spartial operations: <em>is within</em>, <em>contains</em>, <em>intersects</em>, etc. Check <a href="https://lucene.apache.org/core/7_4_0/spatial-extras/index.html">SpatialOperation</a>.</li>
  <li>It has distance and other spatial related math calculations.</li>
</ul>

<h2 id="jeospatial">Jeospatial</h2>

<p><a href="https://jchambers.github.io/jeospatial/">Jeospatial</a> is a geospatial library that provides <em>a set of 
tools for solving the k-nearest-neighbor problem on the earth’s surface</em>. It is implemented using 
<a href="https://en.wikipedia.org/wiki/Vantage-point_tree">Vantage-point trees</a>, and claims to have <code class="language-plaintext highlighter-rouge">O(n log(n))</code> 
time complexity for indexing operations and <code class="language-plaintext highlighter-rouge">O(log(n))</code>— for searching. A great visual explanation of how Vantage-point trees are constructed with examples can be found in this <a href="https://fribbels.github.io/vptree/writeup">article</a>.</p>

<div class="img-wrapper">
	<figure>
		
			<img src="/static/img/posts/vp_tree.png" alt="Figure 2. An illustration of a Vantage-point tree." />
		
	</figure>
</div>

<figcaption>Figure 2. An illustration of a Vantage-point tree.</figcaption>

<p>The library is pretty easy and straightforward to use.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Create a custom class to hold an ID</span>
<span class="kd">class</span> <span class="nc">MyGeospatialPoint</span> <span class="kd">extends</span> <span class="nc">SimpleGeospatialPoint</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="nc">MyGeospatialPoint</span><span class="o">(</span><span class="kt">double</span> <span class="n">lat</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lon</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">lat</span><span class="o">,</span> <span class="n">lon</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Init Vantage-point tree and elements to it</span>
<span class="nc">VPTree</span><span class="o">&lt;</span><span class="nc">SimpleGeospatialPoint</span><span class="o">&gt;</span> <span class="n">jeospatialPoints</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VPTree</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">50.4</span><span class="no">D</span><span class="o">,</span> <span class="mf">51.4</span><span class="no">D</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">8.2</span><span class="no">D</span><span class="o">,</span> <span class="mf">11.2</span><span class="no">D</span><span class="o">);</span>
	<span class="n">jeospatialPoints</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyGeospatialPoint</span><span class="o">(</span><span class="n">latitude</span><span class="o">,</span> <span class="n">longitude</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// Get the neareset neighbor for a given point</span>
<span class="kd">final</span> <span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">50.4</span><span class="no">D</span><span class="o">,</span> <span class="mf">51.4</span><span class="no">D</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">8.2</span><span class="no">D</span><span class="o">,</span> <span class="mf">11.2</span><span class="no">D</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">neighbor</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyGeospatialPoint</span><span class="o">)</span> <span class="n">jeospatialPoints</span><span class="o">.</span><span class="na">getNearestNeighbor</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyGeospatialPoint</span><span class="o">(</span><span class="n">latitude</span><span class="o">,</span> <span class="n">longitude</span><span class="o">),</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
<span class="kt">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">neighbor</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span></code></pre></figure>

<p>It is much more clear than the Lucene’s example: init a <code class="language-plaintext highlighter-rouge">VPTree</code>, add points, perform a query. The simplicity doesn’t come without cost, of course - the library is somewhat limited in functionality and can be only to solve k-nearest-neighbor problem. Which is perfectly fine for me, because this is exactly what I needed.</p>

<p>As VPTree can hold only objects of GeospatialPoint type, to attach additional data to objects stored in the index we need to create another class that extends its only implementation SimpleGeospatialPoint and holds required data. Pay attention that <code class="language-plaintext highlighter-rouge">getNearestNeighbor</code> accepts as a second argument the distance in meters.</p>

<p>More info can be found in the official <a href="https://github.com/jchambers/jeospatial">GitHub repository</a>.</p>

<h2 id="the-java-spatial-index">The Java Spatial Index</h2>

<p><a href="https://github.com/aled/jsi">The Java Spatial Index</a> is a Java version of the R-tree spatial indexing 
algorithm as described in the 1984 paper “R-trees: A Dynamic Index Structure for Spatial Searching” by 
Antonin Guttman <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup>.</p>

<div class="img-wrapper">
	<figure>
		
			<img src="/static/img/posts/560px-R-tree.svg.png" alt="Figure 3. An example of an R-tree for 2D rectangles. Image courtesy of Wikipedia." />
		
	</figure>
</div>

<figcaption>Figure 3. An example of an R-tree for 2D rectangles. Image courtesy of Wikipedia.</figcaption>

<p>The main element behind this data structure is a minimum bounding rectangle . The “R” in R-tree stands for 
rectangle. Each rectangle describes a single object, and nearby rectangles are then grouped in another 
rectangle on a higher level <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>. That’s a lot of rectangles in one sentence!</p>

<div class="img-wrapper">
	<figure>
		
			<img src="/static/img/posts/yo_dawg_rectangles.jpg" alt="" />
		
	</figure>
</div>

<p>Alright, enough jokes, let’s have a look at the code example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="nc">RTree</span> <span class="n">rtree</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RTree</span><span class="o">();</span>
<span class="n">rtree</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

<span class="c1">// Index some points</span>
<span class="kt">var</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">50.4</span><span class="no">D</span><span class="o">,</span> <span class="mf">51.4</span><span class="no">D</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">8.2</span><span class="no">D</span><span class="o">,</span> <span class="mf">11.2</span><span class="no">D</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">var</span> <span class="n">rect</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Rectangle</span><span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitude</span><span class="o">,</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitude</span><span class="o">,</span>
								   <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitude</span><span class="o">,</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitude</span><span class="o">);</span>
	<span class="n">rtree</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rect</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
<span class="o">}</span>

<span class="c1">// Perform a query</span>
<span class="kd">final</span> <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">50.4</span><span class="no">D</span><span class="o">,</span> <span class="mf">51.4</span><span class="no">D</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">(</span><span class="mf">8.2</span><span class="no">D</span><span class="o">,</span> <span class="mf">11.2</span><span class="no">D</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">var</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Point</span><span class="o">(</span><span class="n">latitude</span><span class="o">,</span> <span class="n">longitude</span><span class="o">);</span>

<span class="kd">final</span> <span class="kt">var</span> <span class="n">distDegree</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="nc">DistanceUtils</span><span class="o">.</span><span class="na">dist2Degrees</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="nc">DistanceUtils</span><span class="o">.</span><span class="na">EARTH_MEAN_RADIUS_KM</span><span class="o">);</span>

<span class="kd">final</span> <span class="kt">var</span> <span class="n">atomicId</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
<span class="n">rtree</span><span class="o">.</span><span class="na">nearest</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="o">{</span>
	<span class="n">atomicId</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
	<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">},</span> <span class="n">distDegree</span><span class="o">);</span>

<span class="kt">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">atomicId</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></code></pre></figure>

<p>To be honest, the code was a bit confusing for me to write, because:</p>

<ol>
  <li><strong>Rectangles everywhere</strong>. We need to index geo points, but the library supports only rectangles, so we have to create a “fake” rectangles with the same latitude and longitude for both corners.</li>
  <li><strong>Distance argument in “nearest”</strong>. The distance argument to rtree.nearest is a spherical distance in degrees. Here we convert 100km to degrees using Lucene’s DistanceUtils class :) Or, you can just put 0.89932036.</li>
  <li><strong>Usage of AtomicInteger</strong>. This is required, because rtree.nearest requires a lambda for each result. To use a variable inside a lambda it has to be effectively final, which does not allow us to change it, but we change an object’s state. Yeah, whatever.</li>
</ol>

<p>You can find more examples in the <a href="https://github.com/aled/jsi-examples">repository</a>.</p>

<h2 id="benchmarks">Benchmarks</h2>

<p>I ran some benchmarks with all of above implementations. Worth noting, that I measure only querying performance, and not indexing. The reason is that my application should be optimized for read load, and it is totally fine if building indices takes some time. Of course, you can easily adjust the code to benchmark also the indexing phase.</p>

<p>In preparation step, we create 3000 random geo points and store them in the index. During the benchmark itself, we perform a query against the index to find the nearest neighbour within 100 km. The full source code for benchmarks you can find in my <a href="https://github.com/kalimatas/geospatial-benchmarks">GitHub repository</a>. Here are the results.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">java <span class="nt">-jar</span> target/benchmarks.jar <span class="nt">-foe</span> <span class="nb">true</span> <span class="nt">-rf</span> csv <span class="nt">-rff</span> benchmark.csv
...
Benchmark                     Mode  Cnt       Score        Error  Units
MyBenchmark.benchJeospatial  thrpt    3   99235,728 ± 132352,814  ops/s
MyBenchmark.benchJsi         thrpt    3  309795,462 ± 202296,631  ops/s
MyBenchmark.benchLucene      thrpt    3    1199,864 ±   1199,138  ops/s</code></pre></figure>

<p>And visual representation.</p>

<div class="img-wrapper">
	<figure>
		
			<img src="/static/img/posts/geospatial-benchmark-jmh.png" alt="" />
		
	</figure>
</div>

<p>To be honest, I was kind of surprised to find out, that Lucene  performed so badly. It could be because a) its RAMDirectory is just slow or b) I cannot cook it. My guess - some misconfiguration, though I could not figure out what was wrong. I asked a <a href="https://stackoverflow.com/questions/52302394/poor-lucene-in-memory-spatial-index-performance">question on StackOverflow</a>, but so far no answers.</p>

<h2 id="notes">Notes</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://en.wikipedia.org/wiki/Elasticsearch">Elasticsearch on Wikipedia.</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://dl.acm.org/citation.cfm?id=602266">“R-trees: A Dynamic Index Structure for Spatial Searching” by Antonin Guttman.</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://en.wikipedia.org/wiki/Minimum_bounding_rectangle">Minimum bounding rectangle on Wikipedia.</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

	</section>
	<section id="share-page">
	<span>Share this page on</span>
	<a href="https://twitter.com/intent/tweet?text=Java Geospatial In-memory Index&url=https://guzalexander.com/2018/11/04/java-in-memory-geospatial.html&via=&related=" rel="nofollow" target="_blank" title="Share on Twitter">Twitter</a> or
	<a href="https://www.reddit.com/submit?url=https://guzalexander.com/2018/11/04/java-in-memory-geospatial.html&title=Java Geospatial In-memory Index" rel="nofollow" target="_blank" title="Share on Reddit">Reddit</a>
</section>

</article>


			</section>

			<footer class="main-footer">
				<section class="copyright">&copy; Copyright 2021 by Alexander Guz • <a target="_blank" href="/feed.xml">RSS</a></section>
				<section>Built with <a target="_blank" href="https://jekyllrb.com/">Jekyll</a></section>
			</footer>
		</section>
	</section>

	<script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-31916607-1']);
		_gaq.push(['_setDomainName', 'guzalexander.com']);
		_gaq.push(['_trackPageview']);

		(function () {
            var ga = document.createElement('script');ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' === document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga, s);
		})();
	</script>

</body>

</html>
